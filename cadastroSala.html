<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Roomly - Cadastro de Salas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="images/favicon.png">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="images/logoSemFundo.png" alt="Roomly Logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#features">Vantagens</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#rooms">Salas</a></li>
                    <li class="nav-item"><a class="nav-link" href="contato.html">Contato</a></li>
                </ul>
                <div class="ms-lg-3 mt-3 mt-lg-0">
                    <a href="login.html" class="btn btn-outline-primary">Login</a>
                </div>
                <div class="ms-lg-3 mt-3 mt-lg-0 d-flex align-items-center">
                    <span id="userName" class="text-white me-3"></span>
                    <button id="editProfile" class="btn btn-outline-light me-2">Editar usuário?</button>
                    <button id="logout" class="btn btn-outline-danger">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="form-container">
            <h2 class="form-title">Cadastro de Sala</h2>
            <form id="cadastroSalaForm">
                <div class="row g-3">
                    <!-- Código -->
                    <div class="col-12 col-md-3">
                        <label for="codigoSala" class="form-label">Código</label>
                        <input type="text" class="form-control" id="codigoSala" readonly>
                    </div>

                    <!-- Tipo da Sala -->
                    <div class="col-12 col-md-6">
                        <label for="tipoSala" class="form-label">Tipo da Sala *</label>
                        <select class="form-control" id="tipoSala" required>
                            <option value="" disabled selected>Selecione um tipo</option>
                        </select>
                    </div>
                    <!-- Capacidade -->
                    <div class="col-12 col-md-3">
                        <label for="capacidade" class="form-label">Capacidade *</label>
                        <input type="number" class="form-control" id="capacidade" placeholder="Capacidade" min="1"
                            required>
                    </div>

                    <!-- Tamanho m² -->
                    <div class="col-12 col-md-3">
                        <label for="tamanhoM2" class="form-label">Tamanho m² *</label>
                        <input type="number" class="form-control" id="tamanhoM2" placeholder="Tamanho m²" min="1"
                            required>
                    </div>

                    <!-- Valor Hora -->
                    <div class="col-12 col-md-3">
                        <label for="valorHora" class="form-label">Valor hora (R$) *</label>
                        <input type="number" class="form-control" id="valorHora" placeholder="Valor R$" min="1"
                            required>
                    </div>

                    <!-- Localização -->
                    <div class="col-12 col-md-3">
                        <label for="cep" class="form-label">CEP *</label>
                        <input type="text" class="form-control" id="cep" placeholder="Digite o CEP" required>
                    </div>

                    <div class="col-12 col-md-3">
                        <label for="rua" class="form-label">Rua *</label>
                        <input type="text" class="form-control" id="rua" required>
                    </div>

                    <div class="col-12 col-md-3">
                        <label for="cidade" class="form-label">Cidade *</label>
                        <input type="text" class="form-control" id="cidade" required>
                    </div>

                    <div class="col-12 col-md-3">
                        <label for="estado" class="form-label">Estado *</label>
                        <input type="text" class="form-control" id="estado" required>
                    </div>

                    <div class="col-12 col-md-3">
                        <label for="numero" class="form-label">Número *</label>
                        <input type="text" class="form-control" id="numero" placeholder="Número" required>
                    </div>

                    <div class="col-12 col-md-3">
                        <label for="complemento" class="form-label">Complemento </label>
                        <input type="text" class="form-control" id="complemento" placeholder="Número" >
                    </div>

                    <!-- Recursos -->
                    <div class="col-12">
                        <label for="recursos" class="form-label">Recursos disponíveis *</label>
                        <input type="text" class="form-control" id="recursos" placeholder="Wi-Fi, projetor, TV, etc."
                            required>
                    </div>

                    <!-- Mobiliário -->
                    <div class="col-12">
                        <label for="mobilario" class="form-label">Tipo de mobiliário *</label>
                        <input type="text" class="form-control" id="mobilario" placeholder="Cadeiras, mesas, sofá, etc."
                            required>
                    </div>

                    <!-- Descrição -->
                    <div class="col-12">
                        <label for="descricao" class="form-label">Descrição *</label>
                        <input type="text" class="form-control" id="descricao" placeholder="Breve descrição da sala."
                            required>
                    </div>

                    <!-- Disponibilidade -->
                    <div class="col-12">
                        <label class="form-label">Disponibilidade (dias da semana) *</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="domingo" >
                                <label class="form-check-label" for="domingo">Domingo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="segunda" >
                                <label class="form-check-label" for="segunda">Segunda-feira</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="terca" >
                                <label class="form-check-label" for="terca">Terça-feira</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="quarta" >
                                <label class="form-check-label" for="quarta">Quarta-feira</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="quinta" >
                                <label class="form-check-label" for="quinta">Quinta-feira</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sexta" >
                                <label class="form-check-label" for="sexta">Sexta-feira</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sabado">
                                <label class="form-check-label" for="sabado">Sábado</label>
                            </div>
                        </div>
                        <div class="invalid-feedback">Selecione pelo menos um dia da semana</div>
                    </div>

                    <div class="col-12 mt-4">
                        <button type="submit" class="btn btn-primary px-5 py-2">Salvar Cadastro</button>
                        <!-- <a href="index.html" class="btn btn-outline-primary ms-3 px-5 py-2">Cancelar</a> -->
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Gera código aleatório ao carregar a página
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("codigoSala").value = gerarCodigoSala();
        });
        document.addEventListener("DOMContentLoaded", async function () {
    const usuario = await fetchUsuarioLogado();
    if (usuario) {
        console.log("ID do usuário logado:", usuario.id); // Certifique-se de que o ID está sendo exibido
    }
});

        function gerarCodigoSala() {
            return Math.floor(100 + Math.random() * 900);
        }

        // Validações
        document.getElementById("cep").addEventListener("input", function (e) {
            e.target.value = e.target.value.replace(/\D/g, ''); // Só números
        });

        document.getElementById("numero").addEventListener("input", function (e) {
            e.target.value = e.target.value.replace(/\D/g, ''); // Só números
        });

        document.getElementById("tamanhoM2").addEventListener("input", function (e) {
            e.target.value = e.target.value.replace(/\D/g, ''); // Só números
        });

        document.getElementById("capacidade").addEventListener("input", function (e) {
            e.target.value = e.target.value.replace(/\D/g, ''); // Só números
        });

        document.getElementById("cidade").addEventListener("input", function (e) {
            e.target.value = e.target.value.replace(/[^a-zA-Z\s]/g, ''); // Só letras e espaços
        });

        document.getElementById("estado").addEventListener("input", function (e) {
            e.target.value = e.target.value.replace(/[^a-zA-Z\s]/g, ''); // Só letras e espaços
        });

        // Máscara para o CEP (formato XXXXX-XXX)
        document.getElementById("cep").addEventListener("input", function (e) {
            let cep = e.target.value.replace(/\D/g, ''); // Remove tudo que não for número
            if (cep.length <= 5) {
                e.target.value = cep.replace(/(\d{5})(\d{0,3})/, '$1-$2'); // Formata como 12345-xxx
            } else {
                cep = cep.slice(0, 8); // Limita o CEP a 8 dígitos
                e.target.value = cep.replace(/(\d{5})(\d{3})/, '$1-$2'); // Formata como 12345-678
            }
        });


        // Validação do formulário
        document.getElementById('cadastroSalaForm').addEventListener('submit', function (e) {
            e.preventDefault();

            // Verifica se pelo menos um dia da semana foi selecionado
            const checkboxes = document.querySelectorAll('.form-check-input:not(#selecionarTodos)');
            let atLeastOneChecked = false;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) atLeastOneChecked = true;
            });

            if (!atLeastOneChecked) {
                document.querySelector('.invalid-feedback').style.display = 'block';
                return;
            } else {
                document.querySelector('.invalid-feedback').style.display = 'none';
            }

            // Verificação de campos obrigatórios
            const requiredFields = document.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                Swal.fire({
                    title: 'Erro!',
                    text: 'Preencha todos os campos obrigatórios.',
                    icon: 'error',
                    confirmButtonText: 'Ok',
                    background: '#121212',
                    color: '#fff'
                });
                return;
            }

            // Se tudo estiver válido, exibe mensagem de sucesso
            Swal.fire({
                title: 'Cadastro Realizado!',
                text: 'A sala foi cadastrada com sucesso.',
                icon: 'success',
                confirmButtonText: 'Ok',
                background: '#121212',
                color: '#fff'
            }).then(() => {
                // Redireciona para a página principal
                //window.location.href = 'index.html';
            });
        });

        // Validação em tempo real para campos obrigatórios
        document.querySelectorAll('[required]').forEach(field => {
            field.addEventListener('input', function () {
                if (this.value) {
                    this.classList.remove('is-invalid');
                }
            });
        });

        document.getElementById('cep').addEventListener('blur', async function () {
    const cep = this.value.replace(/\D/g, '');

    if (cep.length !== 8) {
        alert('CEP inválido.');
        return;
    }

    try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();

        if (data.erro) {
            alert('CEP não encontrado.');
            return;
        }

        document.getElementById('rua').value = data.logradouro;
        document.getElementById('cidade').value = data.localidade;
        document.getElementById('estado').value = data.uf;
    } catch (error) {
        alert('Erro ao buscar CEP.');
        console.error(error);
    }
});
async function fetchUsuarioLogado() {
    try {
        const response = await fetch("http://127.0.0.1:8000/usuario-logado", {
            method: "GET",
            credentials: "include"
        });
        const data = await response.json();

        if (data.logado) {
            document.getElementById("userName").textContent = `Olá, ${data.nome}`;
            document.querySelector(".btn-outline-primary").style.display = "none"; // Esconde o botão de login
            return data;
        } else {
            window.location.href = "login.html";
        }
    } catch (error) {
        console.error("Erro ao buscar usuário logado:", error);
        window.location.href = "login.html";
    }
}
document.getElementById("logout").addEventListener("click", async function () {
    try {
        await fetch("http://127.0.0.1:8000/logout", {
            method: "POST",
            credentials: "include"
        });
        window.location.href = "index.html";
    } catch (error) {
        console.error("Erro ao fazer logout:", error);
    }
});
document.getElementById("editProfile").addEventListener("click", function () {
    window.location.href = "editarcadastro.html";
});

// Preenche o campo "Tipo da Sala" com os dados do banco
async function carregarTiposSala() {
    try {
        const response = await fetch('http://127.0.0.1:8000/tipos-sala'); // URL do endpoint
        const tiposSala = await response.json();

        const selectTipoSala = document.getElementById('tipoSala');
        tiposSala.forEach(tipo => {
            const option = document.createElement('option');
            option.value = tipo.ID_Tipo_Sala; // Salva o ID do tipo de sala
            option.textContent = tipo.Tipo; // Mostra o nome do tipo de sala
            selectTipoSala.appendChild(option);
        });
    } catch (error) {
        console.error('Erro ao carregar tipos de sala:', error);
    }
}

// Chama a função ao carregar a página
document.addEventListener('DOMContentLoaded', carregarTiposSala);

document.getElementById("cadastroSalaForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    // Captura os valores do formulário
    const tipoSalaId = document.getElementById("tipoSala").value;
    const capacidade = document.getElementById("capacidade").value;
    const tamanhoM2 = document.getElementById("tamanhoM2").value;
    const valorHora = document.getElementById("valorHora").value;
    const recursos = document.getElementById("recursos").value;
    const tipoMobilia = document.getElementById("mobilario").value;
    const cep = document.getElementById("cep").value.replace(/\D/g, '');
    const rua = document.getElementById("rua").value;
    const cidade = document.getElementById("cidade").value;
    const estado = document.getElementById("estado").value;
    const numero = document.getElementById("numero").value;
    const complemento = document.getElementById("complemento").value;
    const descricao = document.getElementById("descricao").value;

    // Captura os valores dos checkboxes
    const domingo = document.getElementById("domingo").checked ? 1 : 0;
    const segunda = document.getElementById("segunda").checked ? 1 : 0;
    const terca = document.getElementById("terca").checked ? 1 : 0;
    const quarta = document.getElementById("quarta").checked ? 1 : 0;
    const quinta = document.getElementById("quinta").checked ? 1 : 0;
    const sexta = document.getElementById("sexta").checked ? 1 : 0;
    const sabado = document.getElementById("sabado").checked ? 1 : 0;

    // ID do usuário logado
    const usuario = await fetchUsuarioLogado();
    const fkUsuarioId = usuario.id;

    // Monta o objeto para enviar ao backend
    const sala = {
        capacidade: parseInt(capacidade),
        tamanho: parseFloat(tamanhoM2),
        valor_hora: parseFloat(valorHora),
        recursos,
        tipo_mobilia: tipoMobilia,
        cep,
        rua,
        cidade,
        estado,
        numero: parseInt(numero),
        complemento,
        descricao,
        fk_tipo_sala_id: parseInt(tipoSalaId),
        fk_usuario_id: parseInt(fkUsuarioId),
        domingo,
        segunda,
        terca,
        quarta,
        quinta,
        sexta,
        sabado,
        status: 1 // Status padrão
    };

    try {
        // Envia os dados ao backend
        const response = await fetch("http://127.0.0.1:8000/salas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(sala)
        });

        const result = await response.json();

        if (result.success) {
            Swal.fire({
                title: "Sucesso!",
                text: result.message,
                icon: "success",
                confirmButtonText: "Ok",
                background: "#121212",
                color: "#fff"
            }).then(() => {
                window.location.href = "index.html"; // Redireciona após o cadastro
            });
        } else {
            Swal.fire({
                title: "Erro!",
                text: result.message,
                icon: "error",
                confirmButtonText: "Ok",
                background: "#121212",
                color: "#fff"
            });
        }
    } catch (error) {
        console.error("Erro ao cadastrar sala:", error);
        Swal.fire({
            title: "Erro!",
            text: "Ocorreu um erro ao cadastrar a sala.",
            icon: "error",
            confirmButtonText: "Ok",
            background: "#121212",
            color: "#fff"
        });
    }
});

    </script>
</body>

</html>