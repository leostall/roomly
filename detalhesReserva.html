<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Roomly - Minhas Reservas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="images/favicon.png">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="images/logoSemFundo.png" alt="Roomly Logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#features">Vantagens</a></li>
                    <li class="nav-item"><a class="nav-link" href="todasSalas.html">Salas</a></li>
                    <li class="nav-item"><a class="nav-link" href="contato.html">Contato</a></li>
                </ul>
                <div class="ms-lg-3 mt-3 mt-lg-0" id="auth-buttons">
                    <div class="dropdown" id="user-dropdown" style="display: none;">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="dropdownMenuButton"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <span id="user-greeting">Olá, Usuário!</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" onclick="showEditUserModal()"><i
                                        class="bi bi-person me-2"></i>Editar
                                    usuário</a></li>
                            <li><a class="dropdown-item" href="detalhesReserva.html"><i
                                        class="bi bi-calendar-check me-2"></i>Minhas Reservas</a></li>
                            <div id="admin-items" style="display: none;">
                                <li><a class="dropdown-item" href="#" id="editRooms"><i
                                            class="bi bi-pencil-square me-2"></i>Minhas
                                        Salas</a></li>
                                <li><a class="dropdown-item" onclick="showCadastroSalaModal();"><i
                                            class="bi bi-plus-circle me-2"></i>Registrar Sala</a></li>
                                <li><a class="dropdown-item" href="#" id="manage-room-types"><i
                                            class="bi bi-tags me-2"></i>Tipos de
                                        Sala</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                            </div>
                            <li><a class="dropdown-item" href="#" id="logout"><i
                                        class="bi bi-box-arrow-right me-2"></i>Sair</a></li>
                        </ul>
                    </div>
                    <a href="login.html" class="btn btn-outline-primary" id="login-btn">Login</a>
                </div>
            </div>
        </div>
    </nav>

    <section class="rooms-hero">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <h1>Minhas Reservas</h1>
                    <p>Gerencie todas as suas reservas de salass</p>
                </div>
            </div>
        </div>
    </section>

    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 mb-4">
                    <div class="card bg-dark border-0 rounded-lg shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title text-accent mb-4">Filtrar Reservas</h5>
                            <div class="mb-3">
                                <label for="nomeSalaFiltro" class="form-label">Nome da Sala</label>
                                <input type="text" class="form-control" id="nomeSalaFiltro" placeholder="Digite o nome">
                            </div>
                            <div class="mb-3">
                                <label for="tipoSalaFiltro" class="form-label">Tipo de Sala</label>
                                <select class="form-select form-select-dark" id="tipoSalaFiltro">
                                    <option value="" selected>Todos os tipos</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="dataCheckinFiltro" class="form-label">Data de Check-in</label>
                                <input type="date" class="form-control" id="dataCheckinFiltro">
                            </div>
                            <div class="mb-3">
                                <label for="statusReservaFiltro" class="form-label">Status</label>
                                <select class="form-select form-select-dark" id="statusReservaFiltro">
                                    <option value="" selected>Todos</option>
                                    <option value="ativa">Ativa</option>
                                    <option value="passada">Passada</option>
                                    <option value="cancelada">Cancelada</option>
                                </select>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" id="btnFiltrar">
                                    <i class="bi bi-funnel me-2"></i>Filtrar
                                </button>
                                <button class="btn btn-outline-primary" id="btnLimparFiltros">
                                    <i class="bi bi-arrow-counterclockwise me-2"></i>Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Suas reservas</h4>
                        <button class="btn btn-primary" id="btnExportarPDF">
                            <i class="bi bi-file-earmark-pdf me-2"></i>Exportar PDF
                        </button>
                    </div>
                    <div id="listaReservas"></div>
                    <div id="semReservas" class="alert alert-dark text-center" style="display: none;">
                        <i class="bi bi-calendar-x fs-1 mb-3"></i>
                        <h5>Nenhuma reserva encontrada</h5>
                        <p class="mb-0">Você ainda não fez nenhuma reserva ou não há reservas com os filtros aplicados.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="row g-4">
                <div class="col-lg-5 mb-4 mb-lg-0">
                    <img src="images/logoSemFundo.png" alt="Roomly Logo" class="footer-logo mb-3">
                    <p class="pe-lg-5">Transformando a forma como você trabalha. Espaços flexíveis para equipes de todos
                        os tamanhos.</p>
                </div>
                <div class="col-lg-2 col-md-4 mb-4 mb-md-0">
                    <div class="footer-links">
                        <h5 class="mb-3">Links</h5>
                        <ul class="list-unstyled">
                            <li class="mb-2"><a href="index.html" class="d-block py-1">Home</a></li>
                            <li class="mb-2"><a href="index.html#features" class="d-block py-1">Vantagens</a></li>
                            <li class="mb-2"><a href="todasSalas.html" class="d-block py-1">Salas</a></li>
                            <li class="mb-2"><a href="contato.html" class="d-block py-1">Contato</a></li>
                        </ul>
                    </div>
                </div>

                <div class="col-lg-5 col-md-8">
                    <div class="footer-links">
                        <h5 class="mb-3">Contato</h5>
                        <ul class="list-unstyled">
                            <li class="mb-3 d-flex align-items-start">
                                <i class="bi bi-geo-alt me-2 mt-1"></i>
                                <span>Av. Paulista, 1000 - São Paulo, SP</span>
                            </li>
                            <li class="mb-3 d-flex align-items-center">
                                <i class="bi bi-telephone me-2"></i>
                                <span>(11) 9999-9999</span>
                            </li>
                            <li class="mb-3 d-flex align-items-center">
                                <i class="bi bi-envelope me-2"></i>
                                <span>contato@roomly.com</span>
                            </li>
                            <li class="mb-3 d-flex align-items-center">
                                <i class="bi bi-clock me-2"></i>
                                <span>Seg-Sex: 8h-20h | Sáb: 9h-14h</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="copyright text-center mt-5 pt-4">
                <p class="mb-0">&copy; 2025 Roomly. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="modalSistema.js"></script>
    <script src="auth.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            checkUserLoggedIn().then(isLogged => {
                if (isLogged) {
                    carregarReservas();
                } else {
                    document.getElementById('listaReservas').innerHTML = '';
                    document.getElementById('semReservas').innerHTML = `
                        <i class="bi bi-exclamation-circle fs-1 mb-3"></i>
                        <h5>Acesso Negado</h5>
                        <p class="mb-0">Você precisa estar logado para ver suas reservas. <a href="login.html">Faça login</a>.</p>`;
                    document.getElementById('semReservas').style.display = 'block';
                }
            }).catch(() => {
                document.getElementById('listaReservas').innerHTML = '';
                document.getElementById('semReservas').innerHTML = `
                        <i class="bi bi-emoji-dizzy fs-1 mb-3"></i>
                        <h5>Erro de Autenticação</h5>
                        <p class="mb-0">Não foi possível verificar seu status de login. Tente recarregar a página.</p>`;
                document.getElementById('semReservas').style.display = 'block';
            });

            document.getElementById('btnFiltrar').addEventListener('click', function () {
                Swal.fire({
                    title: 'Filtro', text: 'Funcionalidade de filtro em desenvolvimento.', icon: 'info',
                    confirmButtonText: 'Entendi', background: '#121212', color: '#fff'
                });
            });

            document.getElementById('btnLimparFiltros').addEventListener('click', function () {
                document.getElementById('nomeSalaFiltro').value = '';
                document.getElementById('tipoSalaFiltro').value = '';
                document.getElementById('dataCheckinFiltro').value = '';
                document.getElementById('statusReservaFiltro').value = '';
                carregarReservas();
            });

            document.getElementById('btnExportarPDF').addEventListener('click', function () {
                Swal.fire({
                    title: 'Exportar para PDF', text: 'Funcionalidade em desenvolvimento.', icon: 'info',
                    confirmButtonText: 'Entendi', background: '#121212', color: '#fff'
                });
            });
        });

        async function carregarReservas() {
            const listaReservasDiv = document.getElementById('listaReservas');
            const semReservasDiv = document.getElementById('semReservas');
            listaReservasDiv.innerHTML = '';
            semReservasDiv.style.display = 'none';

            try {
                const response = await fetch('http://127.0.0.1:8000/minhas-reservas', {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        semReservasDiv.innerHTML = `
                            <i class="bi bi-exclamation-circle fs-1 mb-3"></i>
                            <h5>Acesso Negado</h5>
                            <p class="mb-0">Sua sessão expirou ou você não está logado. <a href="login.html">Faça login</a>.</p>`;
                        semReservasDiv.style.display = 'block';
                        return;
                    }
                    const errorData = await response.json().catch(() => ({ detail: 'Erro desconhecido.' }));
                    throw new Error(errorData.detail || `Erro ${response.status}`);
                }

                const reservas = await response.json();

                if (reservas.length === 0) {
                    semReservasDiv.innerHTML = `
                        <i class="bi bi-calendar-x fs-1 mb-3"></i>
                        <h5>Nenhuma reserva encontrada</h5>
                        <p class="mb-0">Você ainda não fez nenhuma reserva.</p>`;
                    semReservasDiv.style.display = 'block';
                } else {
                    const agora = new Date();

                    reservas.forEach(reserva => {
                        let statusText = 'Agendada'; // Padrão para futuras
                        let statusBadgeClass = 'bg-primary'; // Padrão para futuras
                        let cardExtraClass = '';
                        let botoesHtml = ''; // HTML para os botões ou mensagem

                        // Variáveis para as datas da reserva
                        let dataHoraInicioReserva = null;
                        let dataHoraCheckoutReserva = null;
                        let dataReservaValida = false;

                        // Parsear e validar as datas e horários da reserva
                        if (reserva.data_reserva && reserva.horario_inicio && reserva.horario_fim) {
                            try {
                                const partesData = reserva.data_reserva.split('/'); // Formato "DD/MM/YYYY"
                                const dia = parseInt(partesData[0], 10);
                                const mes = parseInt(partesData[1], 10) - 1; // Mês em JS é 0-indexado
                                const ano = parseInt(partesData[2], 10);

                                const partesHorarioInicio = reserva.horario_inicio.split(':'); // "HH:MM"
                                const horaInicio = parseInt(partesHorarioInicio[0], 10);
                                const minutoInicio = parseInt(partesHorarioInicio[1], 10);

                                const partesHorarioFim = reserva.horario_fim.split(':'); // "HH:MM"
                                const horaFim = parseInt(partesHorarioFim[0], 10);
                                const minutoFim = parseInt(partesHorarioFim[1], 10);

                                // Verifica se todos os componentes são números válidos
                                if (![dia, mes, ano, horaInicio, minutoInicio, horaFim, minutoFim].some(isNaN)) {
                                    dataHoraInicioReserva = new Date(ano, mes, dia, horaInicio, minutoInicio);
                                    dataHoraCheckoutReserva = new Date(ano, mes, dia, horaFim, minutoFim);
                                    dataReservaValida = true;
                                }
                            } catch (e) {
                                console.error(`Erro ao parsear data/hora para reserva ID ${reserva.id_reserva}:`, e);
                            }
                        }

                        if (!dataReservaValida) {
                            statusText = 'Dados Inválidos';
                            statusBadgeClass = 'bg-danger';
                            botoesHtml = `<small class="text-danger">Informações da reserva incompletas.</small>`;
                            console.warn(`Reserva ID: ${reserva.id_reserva} - Dados de data/hora ausentes ou inválidos.`);
                        } else {

                            if (dataHoraCheckoutReserva < agora) {
                                statusText = 'Passada';
                                statusBadgeClass = 'bg-secondary';
                                cardExtraClass = 'reserva-passada';
                                botoesHtml = `<button class="btn btn-outline-secondary btn-sm" disabled><i class="bi bi-eye me-1"></i>Visualizar</button>`;
                                console.log(`Reserva ID: ${reserva.id_reserva} - Status: Passada`);
                            } else {
                                const ehHoje = dataHoraInicioReserva.getFullYear() === agora.getFullYear() &&
                                    dataHoraInicioReserva.getMonth() === agora.getMonth() &&
                                    dataHoraInicioReserva.getDate() === agora.getDate();

                                if (ehHoje) {
                                    statusText = 'Hoje';
                                    statusBadgeClass = 'bg-warning text-dark';
                                    botoesHtml = `
                                        <div class="text-warning small lh-sm d-flex align-items-center">
                                            <i class="bi bi-info-circle-fill me-2"></i>
                                            <span>Só é possível alterar/cancelar com mais de 24h de antecedência.</span>
                                        </div>`;
                                    console.log(`Reserva ID: ${reserva.id_reserva} - Status: É Hoje`);
                                } else {
                                    statusText = 'Agendada';
                                    statusBadgeClass = 'bg-primary';

                                    const diffHorasParaInicio = (dataHoraInicioReserva.getTime() - agora.getTime()) / (1000 * 60 * 60);

                                    if (diffHorasParaInicio >= 24) {
                                        botoesHtml = `
                                            <button class="btn btn-editar btn-sm" onclick="editarReserva(${reserva.id_reserva})">
                                                <i class="bi bi-pencil me-1"></i>Editar
                                            </button>
                                            <button class="btn btn-excluir btn-sm" onclick="cancelarReserva(${reserva.id_reserva})">
                                                <i class="bi bi-trash me-1"></i>Cancelar
                                            </button>`;
                                    } else {
                                        statusText = 'Agendada';
                                        statusBadgeClass = 'bg-primary';
                                        botoesHtml = `
                                            <div class="text-warning small lh-sm d-flex align-items-center">
                                                <i class="bi bi-info-circle-fill me-2"></i>
                                                <span>Só é possível alterar/cancelar com mais de 24h de antecedência.</span>
                                            </div>`;
                                    }
                                }
                            }
                        }

                        const cardHTML = `
                            <div class="card bg-dark mb-4 animate__animated animate__fadeInUp ${cardExtraClass}">
                                <div class="row g-0">
                                    <div class="col-md-4">
                                        <img src="${reserva.imagem_url || 'images/placeholder.jpg'}"
                                            class="img-fluid rounded-start h-100 object-fit-cover" alt="${reserva.tipo_sala || 'Imagem da sala'}">
                                    </div>
                                    <div class="col-md-8">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <h5 class="card-title mb-1">${reserva.tipo_sala || 'Tipo da Sala Indisponível'}</h5>
                                                <span class="badge ${statusBadgeClass} ms-2">${statusText}</span>
                                            </div>
                                            <p class="card-text text-muted mb-2"><i class="bi bi-geo-alt me-2"></i>${reserva.endereco || 'Endereço não informado'}</p>
                                            <p class="card-text mb-2"><i class="bi bi-tag me-2"></i>${reserva.tipo_sala || 'Tipo não informado'}</p>
                                            <p class="card-text mb-2"><i class="bi bi-people-fill me-2"></i>${reserva.capacidade_sala || 'N/A'} pessoas</p>
                                            <p class="card-text mb-2"><i class="bi bi-card-text me-2"></i>${reserva.descricao_sala || 'Descrição não informada'}</p>

                                            <div class="data-horario-bloco my-3 p-3 bg-darker rounded">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <i class="bi bi-calendar-check me-2 text-accent"></i>
                                                        <span>${reserva.data_reserva || 'dd/mm/aaaa'}</span>
                                                    </div>
                                                    <div>
                                                        <i class="bi bi-clock me-2 text-accent"></i>
                                                        <span>${reserva.horario_inicio || '--:--'} - ${reserva.horario_fim || '--:--'}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="d-flex justify-content-end gap-2 mt-3">
                                                ${botoesHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        listaReservasDiv.innerHTML += cardHTML;
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar reservas:', error);
                semReservasDiv.innerHTML = `
                    <i class="bi bi-emoji-dizzy fs-1 mb-3"></i>
                    <h5>Ops! Algo deu errado</h5>
                    <p class="mb-0">Não foi possível carregar suas reservas. Tente novamente mais tarde.</p>
                    <small class="text-muted">${error.message}</small>`;
                semReservasDiv.style.display = 'block';
            }
        }

        function editarReserva(idReserva) {
            Swal.fire({
                title: `Editar Reserva ${idReserva}`, text: 'Esta funcionalidade será implementada em breve.', icon: 'info',
                confirmButtonText: 'Entendi', background: '#121212', color: '#fff'
            });
        }

        function cancelarReserva(idReserva) {
            Swal.fire({
                title: 'Tem certeza?', text: `Você deseja cancelar a reserva ${idReserva}? Esta ação não pode ser desfeita.`,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, cancelar!', cancelButtonText: 'Não', background: '#121212', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Lógica de cancelamento da API aqui...
                    // Se sucesso:
                    // Swal.fire('Cancelada!', `A reserva ${idReserva} foi cancelada.`, 'success');
                    // carregarReservas();
                    // Se erro:
                    // Swal.fire('Erro!', 'Não foi possível cancelar a reserva.', 'error');
                    Swal.fire('Simulado!', `Reserva ${idReserva} cancelada (simulação).`, 'success'); // Placeholder
                }
            });
        }
    </script>
</body>

</html>